<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Provo/Orem Amazing Race Creator</title>

    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/@mapbox/mapbox-gl-geocoder@4.8.0/dist/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@mapbox/mapbox-gl-geocoder@4.8.0/dist/mapbox-gl-geocoder.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #fff;
        }

        header {
            background: linear-gradient(90deg, #FF4500, #FFD700);
            padding: 18px;
            text-align: center;
            font-size: 26px;
            font-weight: bold;
            color: #222;
        }

        .container {
            max-width: 900px;
            margin: auto;
            padding: 20px;
        }

        .step {
            margin: 20px 0;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        button,
        input {
            font-size: 15px;
            padding: 8px;
            margin: 6px 0;
            width: 100%;
        }

        button {
            background: #FF4500;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #e03e00;
        }

        #map {
            height: 450px;
            display: none;
            margin-top: 18px;
        }

        .clueCard {
            border: 1px solid #ccc;
            padding: 8px;
            margin: 10px 0;
            border-radius: 6px;
        }

        .checkbox-group label {
            display: block;
            margin: 4px 0;
        }
    </style>
</head>

<body>

    <header>üèÅ Provo/Orem Amazing Race Creator ‚ù§Ô∏è</header>
    <div class="container">

        <div class="step">
            <h3>Step 1 ‚Äî Generate Suggested Locations</h3>
            <button onclick="showSuggestions()">Generate Suggestions</button>
            <div id="suggestions" class="checkbox-group"></div>
        </div>

        <div class="step">
            <h3>Step 2 ‚Äî Choose 3‚Äì5 Stops</h3>
            <div id="selectedStops"></div>
        </div>

        <div class="step">
            <h3>Step 3 ‚Äî Final Destination</h3>
            <input id="finalInput" placeholder="Type final location (Mapbox search)" />
            <button onclick="geocodeFinal()">Set Final Destination</button>
            <div id="finalDisplay"></div>
        </div>

        <div class="step">
            <h3>Step 4 ‚Äî Choose Riddle Style</h3>
            <select id="riddleStyle">
                <option value="Romantic">Romantic</option>
                <option value="Playful">Playful</option>
                <option value="Challenging">Challenging</option>
            </select>
        </div>

        <button onclick="planRace()">Plan Race & Generate Clues</button>

        <div id="output"></div>

        <button onclick="downloadPDF()">Export to PDF</button>

        <div id="map"></div>

    </div>

    <script>
        mapboxgl.accessToken = "YOUR_MAPBOX_TOKEN_HERE";

        // Curated spots list
        const curated = [
            "Rock Canyon Trailhead",
            "Kiwanis Park",
            "Hillcrest Pickleball Courts",
            "Provo River Parkway",
            "Y Trail Parking Lot",
            "BYU Creamery",
            "Provo City Center Temple",
            "Utah Lake Marina",
            "Memorial Park (Provo)",
            "Covey Center for the Arts"
        ];

        let selectedStops = [];
        let finalSpot = null;

        // Show checkboxes
        function showSuggestions() {
            let container = document.getElementById("suggestions");
            container.innerHTML = "";
            curated.sort(() => Math.random() - 0.5).forEach((loc, i) => {
                container.innerHTML += `<label>
      <input type="checkbox" value="${loc}" onchange="toggleStop(this)" /> ${loc}
    </label>`;
            });
        }

        function toggleStop(el) {
            const val = el.value;
            if (el.checked) {
                if (selectedStops.length >= 5) {
                    alert("Max 5 stops!");
                    el.checked = false;
                    return;
                }
                selectedStops.push(val);
            } else {
                selectedStops = selectedStops.filter(x => x !== val);
            }
            document.getElementById("selectedStops").innerText = selectedStops.join(", ");
        }

        // Geocode final
        async function geocodeFinal() {
            const query = document.getElementById("finalInput").value.trim();
            if (!query) return alert("Type a final location!");
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}`;
            const res = await fetch(url);
            const data = await res.json();
            if (!data.features || !data.features.length) return alert("Location not found!");
            finalSpot = data.features[0].place_name;
            document.getElementById("finalDisplay").innerText = "Final: " + finalSpot;
        }

        function makeClue(style, from, to) {
            const banks = {
                Romantic: [
                    `From the charm of the first stop toward warmth of the next, let your hearts wander.`,
                    `Let laughter guide you from one treasured view to another.`,
                ],
                Playful: [
                    `Bounce past the trail of wonders to your next hidden delight!`,
                    `Skip along from here to where sunshine and smiles await!`
                ],
                Challenging: [
                    `Seek the twist between these two lands and read the signs for what comes next.`,
                    `Puzzle your way from this open space to the shadows ahead.`
                ]
            };
            const arr = banks[style] || banks.Playful;
            return arr[Math.floor(Math.random() * arr.length)];
        }

        async function planRace() {
            if (selectedStops.length < 3) return alert("Pick at least 3 stops!");
            if (!finalSpot) return alert("Set final destination!");
            const style = document.getElementById("riddleStyle").value;

            // Two team orders (one normal, one reversed)
            const teamA = [...selectedStops];
            const teamB = [...selectedStops].reverse();

            let html = `<h2>Team A</h2>`;
            teamA.forEach((loc, i) => {
                const nextLoc = i < teamA.length - 1 ? teamA[i + 1] : finalSpot;
                html += `<div class="clueCard">
      <strong>A${i + 1}:</strong> ${makeClue(style, loc, nextLoc)}
    </div>`;
            });
            html += `<h2>Team B</h2>`;
            teamB.forEach((loc, i) => {
                const nextLoc = i < teamB.length - 1 ? teamB[i + 1] : finalSpot;
                html += `<div class="clueCard">
      <strong>B${i + 1}:</strong> ${makeClue(style, loc, nextLoc)}
    </div>`;
            });

            document.getElementById("output").innerHTML = html;
            drawMapPaths(teamA, teamB, finalSpot);
        }

        async function getCoords(name) {
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(name)}.json?access_token=${mapboxgl.accessToken}`;
            const res = await fetch(url);
            const data = await res.json();
            return data.features?.[0]?.geometry?.coordinates;
        }

        async function drawMapPaths(A, B, finalName) {
            const allNames = [...new Set([...A, ...B, finalName])];
            const coords = {};
            for (const name of allNames) {
                const c = await getCoords(name);
                if (c) coords[name] = c;
            }

            document.getElementById("map").style.display = "block";
            const map = new mapboxgl.Map({
                container: "map",
                style: "mapbox://styles/mapbox/streets-v11",
                center: coords[allNames[0]] || [-111.65, 40.25],
                zoom: 11
            });

            function drawLine(path, color) {
                const line = path.map(n => coords[n]);
                map.on('load', () => {
                    map.addSource(color + path.join("-"), {
                        type: "geojson", data: {
                            type: "Feature",
                            geometry: { type: "LineString", coordinates: line }
                        }
                    });
                    map.addLayer({
                        id: color + path.join("-"), type: "line",
                        source: color + path.join("-"),
                        layout: { "line-join": "round", "line-cap": "round" },
                        paint: { "line-color": color, "line-width": 4 }
                    });
                });
            }

            drawLine([...A, finalName], "red");
            drawLine([...B, finalName], "blue");

            // markers
            allNames.forEach(name => {
                new mapboxgl.Marker().setLngLat(coords[name]).setPopup(new mapboxgl.Popup().setText(name)).addTo(map);
            });
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(document.getElementById("output").innerText, 10, 10);
            doc.save("AmazingRace.pdf");
        }
    </script>

</body>

</html>